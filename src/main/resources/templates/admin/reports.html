<!-- templates/admin/reports.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/admin-layout :: adminLayout(~{::content})}">
<head>
    <title>StudyHub ê´€ë¦¬ì - ì‹ ê³  ê´€ë¦¬</title>
</head>
<body>
    <div th:fragment="content">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="content-header">
            <h1 class="page-title">
                <span th:if="${isPendingList}">ëŒ€ê¸°ì¤‘ì¸ ì‹ ê³ </span>
                <span th:unless="${isPendingList}">ì‹ ê³  ê´€ë¦¬</span>
            </h1>
            <p class="page-subtitle">
                <span th:if="${isPendingList}">ì²˜ë¦¬ ëŒ€ê¸°ì¤‘ì¸ ì‹ ê³ ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤</span>
                <span th:unless="${isPendingList}">ì „ì²´ ì‹ ê³  ë‚´ì—­ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</span>
            </p>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <div class="stat-title">ëŒ€ê¸°ì¤‘ì¸ ì‹ ê³ </div>
                <div class="stat-value" id="pendingCount">-</div>
                <div class="stat-change">ì²˜ë¦¬ í•„ìš”</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-title">ì „ì²´ ì‹ ê³ </div>
                <div class="stat-value" id="totalCount">-</div>
                <div class="stat-change">ëˆ„ì  ì‹ ê³ </div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="stat-card" style="margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <select id="statusFilter" style="padding: 0.75rem; border: 1px solid rgba(255, 92, 56, 0.3); 
                                               border-radius: 8px; background: rgba(244, 239, 233, 0.1); color: #F4EFE9;">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="PENDING">ëŒ€ê¸°ì¤‘</option>
                    <option value="APPROVED">ìŠ¹ì¸</option>
                    <option value="REJECTED">ê±°ë¶€</option>
                    <option value="RESOLVED">ì²˜ë¦¬ì™„ë£Œ</option>
                </select>
                <select id="targetTypeFilter" style="padding: 0.75rem; border: 1px solid rgba(255, 92, 56, 0.3); 
                                                   border-radius: 8px; background: rgba(244, 239, 233, 0.1); color: #F4EFE9;">
                    <option value="">ì „ì²´ íƒ€ì…</option>
                    <option value="POST">ê²Œì‹œê¸€</option>
                    <option value="COMMENT">ëŒ“ê¸€</option>
                    <option value="USER">ì‚¬ìš©ì</option>
                </select>
                <button class="btn" onclick="searchReports()">ê²€ìƒ‰</button>
                <button class="btn" onclick="resetSearch()">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ì‹ ê³  ëª©ë¡ -->
        <div class="stat-card">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h3 style="color: #FF5C38;">ì‹ ê³  ëª©ë¡</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="refreshReports()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì‹ ê³ ì</th>
                        <th>ëŒ€ìƒ íƒ€ì…</th>
                        <th>ëŒ€ìƒ ID</th>
                        <th>ì‚¬ìœ </th>
                        <th>ì‹ ê³ ì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem;">
                            <p style="color: #7FE7DC;">ë¡œë”© ì¤‘...</p>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div id="pagination" style="display: flex; justify-content: center; margin-top: 2rem; gap: 0.5rem;">
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- ì‹ ê³  ì²˜ë¦¬ ëª¨ë‹¬ -->
        <div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                    background: rgba(0, 0, 0, 0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        background: #2C2E33; border-radius: 15px; padding: 2rem; min-width: 500px; 
                        border: 1px solid rgba(255, 92, 56, 0.3);">
                <h3 style="color: #FF5C38; margin-bottom: 1rem;">ì‹ ê³  ì²˜ë¦¬</h3>
                <div id="reportDetailContent">
                    <!-- ì‹ ê³  ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div style="margin-top: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: #F4EFE9;">ì²˜ë¦¬ ê²°ê³¼:</label>
                    <select id="resolutionStatus" style="width: 100%; padding: 0.75rem; border: 1px solid rgba(255, 92, 56, 0.3); 
                                                         border-radius: 8px; background: rgba(244, 239, 233, 0.1); color: #F4EFE9; margin-bottom: 1rem;">
                        <option value="APPROVED">ìŠ¹ì¸</option>
                        <option value="REJECTED">ê±°ë¶€</option>
                        <option value="RESOLVED">ì²˜ë¦¬ì™„ë£Œ</option>
                    </select>
                    <label style="display: block; margin-bottom: 0.5rem; color: #F4EFE9;">ì²˜ë¦¬ ë©”ëª¨:</label>
                    <textarea id="resolutionNote" rows="3" style="width: 100%; padding: 0.75rem; border: 1px solid rgba(255, 92, 56, 0.3); 
                                                                 border-radius: 8px; background: rgba(244, 239, 233, 0.1); color: #F4EFE9; resize: vertical;"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeReportModal()">ì·¨ì†Œ</button>
                    <button class="btn btn-success" onclick="resolveReport()">ì²˜ë¦¬ ì™„ë£Œ</button>
                </div>
            </div>
        </div>

        <script>
            let currentPage = 0;
            let currentStatus = '';
            let currentTargetType = '';
            let currentReportId = null;

            // ì‹ ê³  ëª©ë¡ ë¡œë“œ
            async function loadReports(page = 0, status = '', targetType = '') {
                try {
                    let url = `/admin/reports/api?page=${page}&size=20`;
                    if (status) url += `&status=${status}`;
                    if (targetType) url += `&targetType=${targetType}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    renderReportsTable(data.content);
                    renderPagination(data);
                    
                } catch (error) {
                    console.error('ì‹ ê³  ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('reportsTableBody').innerHTML = 
                        '<tr><td colspan="8" style="text-align: center; color: #dc3545;">ë¡œë”© ì‹¤íŒ¨</td></tr>';
                }
            }

            // ì‹ ê³  í†µê³„ ë¡œë“œ
            async function loadReportStats() {
                try {
                    const response = await fetch('/admin/reports/stats');
                    const stats = await response.json();
                    
                    document.getElementById('pendingCount').textContent = stats.pending || 0;
                    document.getElementById('totalCount').textContent = stats.total || 0;
                } catch (error) {
                    console.error('ì‹ ê³  í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }

            // ì‹ ê³  í…Œì´ë¸” ë Œë”ë§
            function renderReportsTable(reports) {
                const tbody = document.getElementById('reportsTableBody');
                
                if (!reports || reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #7FE7DC;">ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                const rows = reports.map(report => `
                    <tr>
                        <td>${report.id}</td>
                        <td>${report.reporter ? report.reporter.email : 'ì•Œ ìˆ˜ ì—†ìŒ'}</td>
                        <td>${getTargetTypeText(report.targetType)}</td>
                        <td>${report.targetId}</td>
                        <td>${getReasonText(report.reason)}</td>
                        <td>${new Date(report.reportedAt).toLocaleDateString()}</td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(report.status)}">
                                ${getStatusText(report.status)}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="viewReportDetail(${report.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    ğŸ‘ï¸ ìƒì„¸
                                </button>
                                ${report.status === 'PENDING' ? 
                                    `<button class="btn btn-success" onclick="openReportModal(${report.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                        âš¡ ì²˜ë¦¬
                                    </button>` : ''
                                }
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                tbody.innerHTML = rows;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
            function renderPagination(data) {
                const pagination = document.getElementById('pagination');
                const totalPages = data.totalPages;
                const currentPageNum = data.number;
                
                let paginationHtml = '';
                
                // ì´ì „ í˜ì´ì§€
                if (currentPageNum > 0) {
                    paginationHtml += `<button class="btn" onclick="loadReports(${currentPageNum - 1}, '${currentStatus}', '${currentTargetType}')">ì´ì „</button>`;
                }
                
                // í˜ì´ì§€ ë²ˆí˜¸
                for (let i = Math.max(0, currentPageNum - 2); i <= Math.min(totalPages - 1, currentPageNum + 2); i++) {
                    paginationHtml += `<button class="btn ${i === currentPageNum ? 'btn-success' : ''}" 
                                               onclick="loadReports(${i}, '${currentStatus}', '${currentTargetType}')">${i + 1}</button>`;
                }
                
                // ë‹¤ìŒ í˜ì´ì§€
                if (currentPageNum < totalPages - 1) {
                    paginationHtml += `<button class="btn" onclick="loadReports(${currentPageNum + 1}, '${currentStatus}', '${currentTargetType}')">ë‹¤ìŒ</button>`;
                }
                
                pagination.innerHTML = paginationHtml;
            }

            // ì‹ ê³  ê²€ìƒ‰
            function searchReports() {
                const status = document.getElementById('statusFilter').value;
                const targetType = document.getElementById('targetTypeFilter').value;
                
                currentStatus = status;
                currentTargetType = targetType;
                currentPage = 0;
                
                loadReports(currentPage, status, targetType);
            }

            // ê²€ìƒ‰ ì´ˆê¸°í™”
            function resetSearch() {
                document.getElementById('statusFilter').value = '';
                document.getElementById('targetTypeFilter').value = '';
                
                currentStatus = '';
                currentTargetType = '';
                currentPage = 0;
                
                loadReports(currentPage, '', '');
            }

            // ì‹ ê³  ì²˜ë¦¬ ëª¨ë‹¬ ì—´ê¸°
            async function openReportModal(reportId) {
                try {
                    const response = await fetch(`/admin/reports/${reportId}`);
                    const report = await response.json();
                    
                    currentReportId = reportId;
                    const modal = document.getElementById('reportModal');
                    const content = document.getElementById('reportDetailContent');
                    
                    content.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <strong>ì‹ ê³ ì:</strong> ${report.reporter ? report.reporter.email : 'ì•Œ ìˆ˜ ì—†ìŒ'}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ëŒ€ìƒ:</strong> ${getTargetTypeText(report.targetType)} (ID: ${report.targetId})
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ì‚¬ìœ :</strong> ${getReasonText(report.reason)}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ìƒì„¸ ë‚´ìš©:</strong><br>
                            <div style="background: rgba(244, 239, 233, 0.1); padding: 1rem; border-radius: 8px; margin-top: 0.5rem;">
                                ${report.description || 'ìƒì„¸ ë‚´ìš© ì—†ìŒ'}
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ì‹ ê³ ì¼:</strong> ${new Date(report.reportedAt).toLocaleString()}
                        </div>
                    `;
                    
                    modal.style.display = 'block';
                } catch (error) {
                    console.error('ì‹ ê³  ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('ì‹ ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }

            // ì‹ ê³  ì²˜ë¦¬
            async function resolveReport() {
                if (!currentReportId) return;
                
                const status = document.getElementById('resolutionStatus').value;
                const note = document.getElementById('resolutionNote').value;
                
                try {
                    const response = await fetch(`/admin/reports/${currentReportId}/resolve`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status, resolutionNote: note })
                    });
                    
                    if (response.ok) {
                        alert('ì‹ ê³ ê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeReportModal();
                        loadReports(currentPage, currentStatus, currentTargetType);
                        loadReportStats();
                    } else {
                        alert('ì‹ ê³  ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ì‹ ê³  ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                    alert('ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì‹ ê³  ìƒì„¸ ì •ë³´ ë³´ê¸°
            async function viewReportDetail(reportId) {
                try {
                    const response = await fetch(`/admin/reports/${reportId}`);
                    const report = await response.json();
                    
                    alert(`
ì‹ ê³  ìƒì„¸ ì •ë³´:
- ID: ${report.id}
- ì‹ ê³ ì: ${report.reporter ? report.reporter.email : 'ì•Œ ìˆ˜ ì—†ìŒ'}
- ëŒ€ìƒ: ${getTargetTypeText(report.targetType)} (ID: ${report.targetId})
- ì‚¬ìœ : ${getReasonText(report.reason)}
- ìƒíƒœ: ${getStatusText(report.status)}
- ì‹ ê³ ì¼: ${new Date(report.reportedAt).toLocaleString()}
- ìƒì„¸ ë‚´ìš©: ${report.description || 'ì—†ìŒ'}
                    `);
                } catch (error) {
                    console.error('ì‹ ê³  ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('ì‹ ê³  ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }

            // ëª¨ë‹¬ ë‹«ê¸°
            function closeReportModal() {
                document.getElementById('reportModal').style.display = 'none';
                currentReportId = null;
                document.getElementById('resolutionNote').value = '';
            }

            // ìƒˆë¡œê³ ì¹¨
            function refreshReports() {
                loadReports(currentPage, currentStatus, currentTargetType);
                loadReportStats();
            }

            // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
            function getTargetTypeText(targetType) {
                const types = {
                    'POST': 'ê²Œì‹œê¸€',
                    'COMMENT': 'ëŒ“ê¸€',
                    'USER': 'ì‚¬ìš©ì'
                };
                return types[targetType] || targetType;
            }

            function getReasonText(reason) {
                const reasons = {
                    'SPAM': 'ìŠ¤íŒ¸',
                    'INAPPROPRIATE_CONTENT': 'ë¶€ì ì ˆí•œ ë‚´ìš©',
                    'HARASSMENT': 'ê´´ë¡­í˜',
                    'COPYRIGHT_VIOLATION': 'ì €ì‘ê¶Œ ì¹¨í•´',
                    'OTHER': 'ê¸°íƒ€'
                };
                return reasons[reason] || reason;
            }

            function getStatusText(status) {
                const statuses = {
                    'PENDING': 'ëŒ€ê¸°ì¤‘',
                    'APPROVED': 'ìŠ¹ì¸',
                    'REJECTED': 'ê±°ë¶€',
                    'RESOLVED': 'ì²˜ë¦¬ì™„ë£Œ'
                };
                return statuses[status] || status;
            }

            function getStatusBadgeClass(status) {
                const classes = {
                    'PENDING': 'badge-pending',
                    'APPROVED': 'badge-approved',
                    'REJECTED': 'badge-rejected',
                    'RESOLVED': 'badge-approved'
                };
                return classes[status] || 'badge-pending';
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¡œë“œ
            document.addEventListener('DOMContentLoaded', () => {
                loadReports();
                loadReportStats();
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.getElementById('reportModal').addEventListener('click', (e) => {
                if (e.target.id === 'reportModal') {
                    closeReportModal();
                }
            });
        </script>
    </div>
</body>
</html> 