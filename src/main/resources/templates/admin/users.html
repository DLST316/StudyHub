<!-- templates/admin/users.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout/admin-layout :: adminLayout(~{::content})}">
<head>
    <title>StudyHub ê´€ë¦¬ì - ì‚¬ìš©ì ê´€ë¦¬</title>
</head>
<body>
    <div th:fragment="content">
        <!-- í˜ì´ì§€ í—¤ë” -->
        <div class="content-header">
            <h1 class="page-title">
                <span th:if="${isBlockedList}">ì°¨ë‹¨ëœ ì‚¬ìš©ì</span>
                <span th:unless="${isBlockedList}">ì‚¬ìš©ì ê´€ë¦¬</span>
            </h1>
            <p class="page-subtitle">
                <span th:if="${isBlockedList}">ì°¨ë‹¨ëœ ì‚¬ìš©ì ëª©ë¡ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</span>
                <span th:unless="${isBlockedList}">ì „ì²´ ì‚¬ìš©ì ëª©ë¡ì„ ê´€ë¦¬í•©ë‹ˆë‹¤</span>
            </p>
        </div>

        <!-- ê²€ìƒ‰ ë° í•„í„° -->
        <div class="stat-card" style="margin-bottom: 2rem;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="ì´ë©”ì¼ ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." 
                       style="flex: 1; min-width: 200px; padding: 0.75rem; border: 1px solid rgba(255, 92, 56, 0.3); 
                              border-radius: 8px; background: rgba(244, 239, 233, 0.1); color: #F4EFE9;">
                <select id="statusFilter" style="padding: 0.75rem; border: 1px solid rgba(255, 92, 56, 0.3); 
                                               border-radius: 8px; background: rgba(244, 239, 233, 0.1); color: #F4EFE9;">
                    <option value="">ì „ì²´ ìƒíƒœ</option>
                    <option value="active">í™œì„±</option>
                    <option value="blocked">ì°¨ë‹¨</option>
                </select>
                <button class="btn" onclick="searchUsers()">ê²€ìƒ‰</button>
                <button class="btn" onclick="resetSearch()">ì´ˆê¸°í™”</button>
            </div>
        </div>

        <!-- ì‚¬ìš©ì ëª©ë¡ -->
        <div class="stat-card">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h3 style="color: #FF5C38;">ì‚¬ìš©ì ëª©ë¡</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn" onclick="exportUsers()">ğŸ“Š ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn" onclick="refreshUsers()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
                </div>
            </div>

            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì´ë¦„</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ìƒíƒœ</th>
                        <th>ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem;">
                            <p style="color: #7FE7DC;">ë¡œë”© ì¤‘...</p>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
            <div id="pagination" style="display: flex; justify-content: center; margin-top: 2rem; gap: 0.5rem;">
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ì€ JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- ì‚¬ìš©ì ìƒì„¸ ëª¨ë‹¬ -->
        <div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                                  background: rgba(0, 0, 0, 0.5); z-index: 2000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                        background: #2C2E33; border-radius: 15px; padding: 2rem; min-width: 400px; 
                        border: 1px solid rgba(255, 92, 56, 0.3);">
                <h3 style="color: #FF5C38; margin-bottom: 1rem;">ì‚¬ìš©ì ìƒì„¸ ì •ë³´</h3>
                <div id="userDetailContent">
                    <!-- ì‚¬ìš©ì ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                    <button class="btn" onclick="closeUserModal()">ë‹«ê¸°</button>
                </div>
            </div>
        </div>

        <script>
            let currentPage = 0;
            let currentSearch = '';
            let currentStatus = '';

            // ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
            async function loadUsers(page = 0, search = '', status = '') {
                try {
                    let url = `/admin/users/api?page=${page}&size=20`;
                    if (search) url += `&search=${encodeURIComponent(search)}`;
                    if (status) url += `&status=${status}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    renderUsersTable(data.content);
                    renderPagination(data);
                    
                } catch (error) {
                    console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    document.getElementById('usersTableBody').innerHTML = 
                        '<tr><td colspan="6" style="text-align: center; color: #dc3545;">ë¡œë”© ì‹¤íŒ¨</td></tr>';
                }
            }

            // ì‚¬ìš©ì í…Œì´ë¸” ë Œë”ë§
            function renderUsersTable(users) {
                const tbody = document.getElementById('usersTableBody');
                
                if (!users || users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #7FE7DC;">ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                const rows = users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.email}</td>
                        <td>${user.name || '-'}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            <span class="badge ${user.blocked ? 'badge-blocked' : 'badge-active'}">
                                ${user.blocked ? 'ì°¨ë‹¨' : 'í™œì„±'}
                            </span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn" onclick="viewUserDetail(${user.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    ğŸ‘ï¸ ìƒì„¸
                                </button>
                                ${user.role === 'ADMIN' ? 
                                    `<button class="btn btn-secondary" disabled style="padding: 0.5rem 1rem; font-size: 0.875rem; cursor: not-allowed;">
                                        ğŸ”’ ê´€ë¦¬ì
                                    </button>` :
                                    user.blocked ? 
                                        `<button class="btn btn-success" onclick="unblockUser(${user.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                            âœ… í•´ì œ
                                        </button>` :
                                        `<button class="btn btn-danger" onclick="blockUser(${user.id})" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                            ğŸš« ì°¨ë‹¨
                                        </button>`
                                }
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                tbody.innerHTML = rows;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
            function renderPagination(data) {
                const pagination = document.getElementById('pagination');
                const totalPages = data.totalPages;
                const currentPageNum = data.number;
                
                let paginationHtml = '';
                
                // ì´ì „ í˜ì´ì§€
                if (currentPageNum > 0) {
                    paginationHtml += `<button class="btn" onclick="loadUsers(${currentPageNum - 1}, '${currentSearch}', '${currentStatus}')">ì´ì „</button>`;
                }
                
                // í˜ì´ì§€ ë²ˆí˜¸
                for (let i = Math.max(0, currentPageNum - 2); i <= Math.min(totalPages - 1, currentPageNum + 2); i++) {
                    paginationHtml += `<button class="btn ${i === currentPageNum ? 'btn-success' : ''}" 
                                               onclick="loadUsers(${i}, '${currentSearch}', '${currentStatus}')">${i + 1}</button>`;
                }
                
                // ë‹¤ìŒ í˜ì´ì§€
                if (currentPageNum < totalPages - 1) {
                    paginationHtml += `<button class="btn" onclick="loadUsers(${currentPageNum + 1}, '${currentSearch}', '${currentStatus}')">ë‹¤ìŒ</button>`;
                }
                
                pagination.innerHTML = paginationHtml;
            }

            // ì‚¬ìš©ì ê²€ìƒ‰
            function searchUsers() {
                const search = document.getElementById('searchInput').value;
                const status = document.getElementById('statusFilter').value;
                
                currentSearch = search;
                currentStatus = status;
                currentPage = 0;
                
                loadUsers(currentPage, search, status);
            }

            // ê²€ìƒ‰ ì´ˆê¸°í™”
            function resetSearch() {
                document.getElementById('searchInput').value = '';
                document.getElementById('statusFilter').value = '';
                
                currentSearch = '';
                currentStatus = '';
                currentPage = 0;
                
                loadUsers(currentPage, '', '');
            }

            // ì‚¬ìš©ì ì°¨ë‹¨
            async function blockUser(userId) {
                if (!confirm('ì´ ì‚¬ìš©ìë¥¼ ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                try {
                    const response = await fetch(`/admin/users/api/${userId}/block`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        alert(result.message || 'ì‚¬ìš©ìê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadUsers(currentPage, currentSearch, currentStatus);
                    } else {
                        alert(result.error || 'ì°¨ë‹¨ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì°¨ë‹¨ ì‹¤íŒ¨:', error);
                    alert('ì°¨ë‹¨ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì‚¬ìš©ì ì°¨ë‹¨ í•´ì œ
            async function unblockUser(userId) {
                if (!confirm('ì´ ì‚¬ìš©ìì˜ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                try {
                    const response = await fetch(`/admin/users/api/${userId}/unblock`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    if (response.ok) {
                        alert('ì‚¬ìš©ì ì°¨ë‹¨ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        loadUsers(currentPage, currentSearch, currentStatus);
                    } else {
                        alert('ì°¨ë‹¨ í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }
                } catch (error) {
                    console.error('ì‚¬ìš©ì ì°¨ë‹¨ í•´ì œ ì‹¤íŒ¨:', error);
                    alert('ì°¨ë‹¨ í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }

            // ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ë³´ê¸°
            async function viewUserDetail(userId) {
                try {
                    const response = await fetch(`/admin/users/api/${userId}`);
                    const user = await response.json();
                    
                    const modal = document.getElementById('userModal');
                    const content = document.getElementById('userDetailContent');
                    
                    content.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <strong>ID:</strong> ${user.id}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ì´ë©”ì¼:</strong> ${user.email}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ì´ë¦„:</strong> ${user.name || '-'}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ê°€ì…ì¼:</strong> ${new Date(user.createdAt).toLocaleString()}
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <strong>ìƒíƒœ:</strong> 
                            <span class="badge ${user.blocked ? 'badge-blocked' : 'badge-active'}">
                                ${user.blocked ? 'ì°¨ë‹¨' : 'í™œì„±'}
                            </span>
                        </div>
                    `;
                    
                    modal.style.display = 'block';
                } catch (error) {
                    console.error('ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            }

            // ëª¨ë‹¬ ë‹«ê¸°
            function closeUserModal() {
                document.getElementById('userModal').style.display = 'none';
            }

            // ìƒˆë¡œê³ ì¹¨
            function refreshUsers() {
                loadUsers(currentPage, currentSearch, currentStatus);
            }

            // ì‚¬ìš©ì ë‚´ë³´ë‚´ê¸°
            function exportUsers() {
                alert('ì‚¬ìš©ì ë°ì´í„° ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
            }

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
            document.addEventListener('DOMContentLoaded', () => {
                loadUsers();
            });

            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            document.getElementById('userModal').addEventListener('click', (e) => {
                if (e.target.id === 'userModal') {
                    closeUserModal();
                }
            });
        </script>
    </div>
</body>
</html> 